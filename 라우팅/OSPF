- OSPF ( Open Shortest Path First )
- 링크 상태 라우팅 프로토콜이다
- 다른 라우터들에게 전체 네트워크 구성을 파악하기 위하여 필요한 정보들을 광고한다.
- 디스턴스 벡터 라우팅 프로토콜이 아니므로 스플릿 호라이즌이나 자동 축약이 적용되지 않는다.
- 현재 사용되고 있는 OSPF 버전은 2이며, IP 패킷에서 프로토콜 번호89번을 사용하여 라우팅 정보를 전송한다.
- 표준 프로토콜로써 대부분의 제조사에서 지원하며, 가장 많이 사용되는 IGP 이다.
- 에어리어 단위로 라우팅을 동작시킨다.
- 적절한 설정을 통하여 특정에어리어에서 발생하는 네트워크 변화가 다른 에어리어로는 전파되지 않게 할 수 있어 큰 규모의 네트워크에서도 안정된 운영을 할 수 있다.

- 기본적인 OSPF 설정
- OSPF가 동작하는 라우터의 각 인터페이스는 하나의 에어리어에 소속된다.

- router ospf 1
- OSPF 설정 모드
- 이 때 사용하는 수를 프로세스 ID라고 하며, 1 ~ 65535 사이의 적당한 값을 사용한다.
- 프로세스 ID는 동일한 라우터에게 복수 개의 OSPF 프로세스를 동작시킬 때 서로 구분하기 위한 목적으로 사용한다. 프로세스 ID는 라우터별로 다른 값을 가져도 상관없다.

- router-id 1.1.1.1
- 라우터 ID를 지정한다.
- OSPF와 같은 링크 상태 라우팅 프로토콜은 라우팅 정보 전송 시 목적지 네트워크, 메트릭 값과 더불어 해당 라우팅 정보를 만든 라우터와 해당 라우팅 정보를 전송하는 라우터가 어느 것인지도 알려준다.
- 이 떄 사용하는 것이 라우터 ID다. 따라서 변동되지 않는 IP 주소를 라우터 ID로 사용하는 것이 좋다
- 자동으로 라우터 ID가 결정되지만, 라우터의 루프백 주소를 라우터 id로 직접 지정하는 것이 안전하다.
- 현재의 라우터에 설정되어 있지 않은 IP 주소를 라우터 ID로 사용해도 된다.
- 직접 라우터 ID를 지정하지 않으면 OSPF가 설정될 당시 동작 중인 인터페이스의 IP 주소 중에서 자동으로 선택된다.
- 루프백 인터페이스에 IP 주소가 설정되어 있으면 그 중에서 가장 높은 것이 라우터 ID가된다.
- 루프백 인터페이스가 없으면, 동작 중인 물리적 인터페이스 중 가장 높은 IP 주소가 라우터 ID가 된다.

- network 1.1.10.1 0.0.0.0 area 0
- network 1.1.123.1 0.0.0.0 area 0
- OSPF에 포함시킬 인터페이스의 IP 주소, 와일드 카드 및 에어리어를 지정한다. 
- 에어리어가 하나일 떄는 아무것이나 사용해도 되지만, 두 개 이상의 에어리어로 구성할 떄에는 그 중 하나는 반드시 에어리어 번호를 0 또는 0.0.0.0으로 설정해야 한다.
- 그리고, 다른 에어리어 들은 항상 백본 에어리어라고 부르는 에어리어 0또는 0.0.0.0과 물리적으로 직접 연결되어야 한다.
 

- OSPF 네이버
- 헬로 패킷을 이용하여 인접한 라우터와 먼저 네이버를 구성한다. 헬로 패킷은 네트워크 종류에 따라 10초 또는 30초마다 전송한다.
- 연속해서 4개의 헬로 패킷을 수신하지 못하면 네이버 관계를 해제하며, 이 타이머를 데드 주기라고 한다
- 인접 라우터에게서 헬로 패킷을 수신하고, 헬로 패킷에 포함된 네이버 리스트에 자신의 라우터 ID가 포함되어 있으면 그 라우터를 네이버라고 간주한다.
- 헬로 패킷에 기록된 에어리어 ID, 암호, 서브넷 마스크 길이, 헬로.데드 주기, 스텁 에어리어 표시가 서로 동일해야 한다.
- 이더넷과 포인트 투 포인트 네트워크에서 OSPF 헬로 패킷의 목적지 IP 주소는 224.0.0.5를 사용한다.


- OSPF 네이버 확인
- show ip ospf neighbor
- Neighbor ID | Pri |   State   | Dead Time | Address |    Interface
   1.1.1.1       1  FULL/DROTHER   00:00:31  1.1.123.1  FastEthernet0/0

- 1. 네이버의 라우터 ID를 표시
- 2. 네이버의 OSPF 우선순위를 표시

- 3. OSPF 네이버 상태와 역할을 표시. 상태가 'Full'인 것은 네이버와 라우팅 정보 교환이 끝남음을 의미
- 이더넷이 접속된 모든 OSPF 라우터끼리 일일이 라우팅 정보를 교환하면 트래픽이 많이 발생한다.
- 이를 피하기 위하여 이더넷에서 OSPF는 라우팅 정보를 하나의 '대표' 라우터에게만 보내고, 이 라우터가 나머지 라우터에게 중계한다.
- 라우팅 정보 중계 역할을 하는 라우터를 'DR(Designated Router)'라고 하며, DR에서 장애가 발생하면 '대신' DR 역할을 하는 라우터를 'BDR(Backup DR)'이라고 한다
- DR도 BDR도 아닌 라우터를 'DROTHER' 라우터라고 한다.
- DR/BDR은 포인트 투 포인트 네트워크에서는 사용되지 않는다. 

- DR/BDR 선출 기준
- 인터페이스의 OSPF 우선순위가 가장 높은 라우터가 DR
- 인터페이스의 OSPF 우선순위가 모두 동일하면(기본값 1), 라우터 ID가 가장 높은 것이 DR, 그 다음이 BDR이다.

- 네이버는 직접 접속되어 있는 라우터 간에 맺어진다.

- 4. 남아 있는 데드 주기를 표시. 이 시간 이내에 헬로 패킷을 수신하지 못하면 해당 네이버를 삭제
- 5. 네이버의 인터페이스에 설정된 IP 주소를 표시
- 6. 네이버와 연결되는 인터페이스를 표시

- EIGRP는 모든 네이버 간에 라우팅 정보를 교환한다. 그러나 OSPF는 라우팅 정보를 교환하는 네이버를 어드제이션트(adjacent) 네이버라고 하며, 이들 간에만 라우팅 정보를 교환한다.
- DROTHER라우터끼리는 어드제이션트 네이버가 되지 못한다.


- OSPF 네이버의 상태 변화
- 다운(Down) 상태
- 네이버에게서 헬로 패킷을 받지 못한 상태

- 이닛(Init) 상태
- 네이버에게서 헬로 패킷을 받았으나 상대 라우터는 아직 나의 헬로 패킷을 수신하지 못한 상태. 이 경우, 상대방이 보낸 헬로 패킷의 네이버 리스트에 나의 라우터 ID가 없다.

- 투 웨이(two-way) 상태
- 네이버와 쌍방향 통신이 이루어진 상태
- 상대 라우터가 보낸 헬로 패킷내의 네이버 리스트에 나의 라우터 ID 가 포함되어 있다. 멀티 액세스 네트워크(이더넷 등)라면 이 단계에서 DR과 BDR을 선출한다.
- 처음 네이버가 맺어지면 DR/BDR이 선출을 위한 공정한 기회를 주기 위하여 웨이트 타임이라고 하는 기간 동안 기다린다.
- 한 번 네이버가 맺어진 후, 장애로 인하여 끊겼다가 다시 네이버가 맺어지는 경우에는 웨이트 타임을 기다리지 않고 바로 DR/BDR을 선출한다.

- 엑스스타드(exstart) 상태
- 라우팅 정보를 교환하는 adjacent 네이버가 되는 첫 단계. 마스터 라우터와 슬레이브 라우터를 선출

- 익스체인지(exchange) 상태
- OSPF의 라우팅 정보를 LSA(Link State Advertisement)라고 한다.
- 이 LSA를 저장하는 장소를 링크 상태 데이터베이스라고 한다. 링크 상태 데이터베이스에는 OSPF 라우터 자신이 알고 있는 모든 상세 네트워크 정보가 저장되어 있다.
- LSA의 헤더만을 DDP(Database Description Packet) or DBD(DataBase Description)라고 부르는 패킷에 담아 상대방에게 전송한다.

- 로딩(loading) 상태
- 상대로부터 DDP 패킷 수신이 끝난 후, 자신에게 없는 정보가 있으면 링크 상태 요청 패킷을 보내어 특정 LSA의 상세 정보를 보내줄 것을 요청하여 해당 정보를 수신하는 단계

- 풀(Full) 상태
- adjacent 라우터들 간에 라우팅 정보교환이 끝난 상태. adjacent 라우터들의 링크 상태 데이터베이스의 내용이 모두 일치하게 된다.

- OSPF는 네이버 라우터와 라우팅 정보(LSA) 교환을 끝낸 다음 5초를 기다린 후 라우팅 알고리즘 계산을 하고 그 결과를 라우팅 테이블에 기록한다.
- OSPF는 최적 경로 계산을 위해서 SPF(Shortest Path First) 또는 Dijkstra 알고리즘을 사용한다.


- OSPF 메트릭
- 코스트라고 부르며, 출발지부터 목적지까지의 각 인터페이스에서 기준 대역폭을 실제 대역폭으로 나눈 값의 합계다.
- 목적지까지 가는 경로상에 존재하는 모든 인터페이스의 OSPF 코스트 값들을 합친 것
- cisco OSPF 기준 대역폭은 10의8승이다.



- 헬로 타이머 조정
- interface [f0/0]
- ip ospf hello-interval [5]
- OSPF는 이더넷과 포인트 투 포인트 인터페이스에서 10초마다 헬로 패킷을 전송한다.
- 빠른 장애 복구를 위하여 위처럼 타이머를 좀 줄일 수 있다.

- OSPF는 네이버 간 헬로 주기가 달라지면 네이버가 해제된다.
- 그래서 양쪽 동일하게 헬로 주기를 조정해야 한다. 데드 주기는 자동으로 헬로 주기의 4배로 변경된다.
- 헬로 주기를 변경하면 데드 주기도 변경된다. 그러나 헬로 주기는 데드 주기를 변경해도 따라 변경되지 않는다.

- show ip ospf interface [f0/]



- OSPF 라우팅 보안
- 패킷 인증 기능을 이용하여 보안을 강화시킬 수 있따.
- 네이버 간에만 인증을 구현하는 RIP, EIGRP 및 BRP와 달리 OSPF는 네이버 인증 외에 특정 에어리어 전체를 인증할 수 있다.
- 암호키 교환방식으로 MD5만을 사용하는 EIGRP와 달리 평문 암호 교환 방식도 지원한다. 그러나 보안성이 거이 없어 잘 사용하지 않는다

- 에어리어 MD5 인증
- router ospf 1
- area [0] authentication message-digest
- exit
- interface [f0/0]
- ip ospf message-digest-key 1 md5 [cisco]
- 라우팅 프로세스로 들어가서 인증키 교환방식을 정의하고, 네이버와 연결되는 인터페이스에서 암호를 지정
- 이떄 암호 및 키 번호가 네이버 간에 일치해야 한다

- MD5 네이버 인증
- interface [s1/0.24]
- ip ospf authentication message-digest
- ip ospf message-digest-key 1 md5 [cisco]
- 네이버 인증을 설정할 때에는 인증방식과 암호를 모두 인터페이스에서 지정


- OSPF에서도 종단 장치가 접속되어 있는 인터페이스에 OSPF 헬로 패킷의 송수신을 차단하는게 보안적으로 좋다
- router ospf 1
- passive-interface [f0/1]


- 디폴트 루트 설정
- ip route 0.0.0.0 0.0.0.0 1.1.123.1
- 정적 경로를 이용하여 디폴트 루트를 설정

- router ospf 1
- default-information originate
- OSPF 프로세스 내에서 다른 네이버에게 디폴트 루트를 광고한다. 이 경우 정적 경로로 설정된 디폴트 루트가 다운되면 다른 네이버에게 디폴트 루트를 광고하지 않는다.
- 항상 디폴트 루트를 광고하려면 default-information originate always 옵션을 사용한다.
