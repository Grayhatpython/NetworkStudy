- STP
- 이더넷 프레임이 장비들 사이에서 빙빙 도는 것을 이더넷 프레임 루핑이라고 한다.
- 스위치에서 이더넷 프레임의 루핑을 방지해주는 것이 스패닝 트리 프로토콜이다.
- IP 패킷을 헤더에 TTL( Time To Live ) 필드가 있어 패킷의 무한 루프를 막아준다.
- 그러나 이더넷 프레임 헤더에는 루프를 방지하는 필드가 없어 STP가 사용된다.
- STP는 IEEE에서 2004년에 개정한 802.1D-2004 표준에 의해서 RSTP( Rapid STP )로 대체되었다.

- 프레임 루프의 영향
- STP가 제대로 동작하지 않으면 엄청나게 많은 브로드캐스트 프레임 즉, 브로드캐스트 폭풍이 일어난다.
- 브로드캐스트 폭풍이 발생하면 스위치들이 이를 처리하느라 정상적인 동작이 어렵다.
- 이 경우 스위치의 LED가 빠른 속도로 깜박이며, 노란색과 녹색이 번갈아 표시된다.
- 브로드캐스트 스톰은 스위치의 동작을 느리게 하거나 아예 다운시키기도 하며, 통신을 하지 않고 편집이나 표계산을 하는 PC들도 수신한 프레임 처리로 인하여 작업속도가 느려진다.

- MAC 주소 테이블 불안정
- 각 스위치들은 동일한 출발지 MAC 주소를 가진 이더넷 프레임을 서로 다른 인터페이스를 통하여 수신하게 된다.
- MAC 주소 테이블이 수시로 변경되는 MAC 테이블 불안정( MAC table instability ) 현상이 발생한다.

- 이중 프레임 수신
- 호스트는 동일한 프레임을 여러 개 수신하게 된다.

- STP 동작 방식
- STP가 동작하면 물리적으로 루프 구조인 네트워크에서 특정 포트를 차단상태로 바꾸어 논리적으로 루프가 발생하지 않게 한다.
- 동작 중인 스위치나 포트가 다운되면 차단상태의 포트를 다시 전송상태로 바꾸어 계속적인 통신이 보장된다.
- STP는 BPDU(Bridge Protocol Data Unit)라는 프레임을 이용하여 루프가 없는 경로를 구성한다.
- BPDU는 설정 BPDU와 TCN(Topology Change Notification) BPDU 두 종류가 있다.
- 설정 BPDU는 스위치 및 포트의 역할을 결정하기 위하여 사용되고, TCN BPDU는 스위치 네트워크 구조가 변경되었을 때 이를 알리기 위하여 사용한다.

- 스위치는 설정 BPDU를 이용하여 루트 스위치를 선출하고, 스위치 포트의 역할을 결정한다.
- 설정 BPDU는 항상 루트 스위치가 만들어 2초마다 전송하고, 다른 스위치들은 이것을 다음 스위치로 중계한다.
- 설정 BPDU에는 브리지 ID, 루트 브리지 ID, 경로값 및 포트ID 등과 각종 타이머 값들이 포함되어 있다.

- 1. 전체 스위치 중에서 루트 스위치를 선택
-  브리지 ID는 2바이트의 우선순위와 6바이트의 MAC 주소로 이루어진다. 브리지 ID에서 사용하는 우선순위는 기본값이 16진수로 8000이며 10진수로 변환하면 32768이다.
-  가장 작은 브리지 ID는 0, 가장 큰 값은 65535이다.

- 2. 루트 스위치가 아닌 모든 스위치에서 루트 포트를 하나씩 선택
-  루트 포트를 선택할 떄 경쟁 포트 간에 다음 사항을 비교
-  1) 경로값의 합이 가장 작은 포트
-  2) 인접 스위치의 브리지 ID가 가장 낮은 포트
-  3) 인접 스위치의 포트 ID가 가장 낮은 포트
-  경로값이란 포트의 속도별로 IEEE에서 미리 정해 놓은 값을 말한다. 속도가 빠를 수록 경로값이 작다.
-  10Mbps (100), 100Mbps (19), 1Gbps (4), 10Gbps (2)
-  경로값의 합은 해당 스위치에서 루트 스위치까지 각 포트의 경로값을 합산한 값이다.
-  포트 ID는 BPDU를 전송하는 포트의 포트 우선순위와 포트 번호로 구성된다. 포트의 우선순위 기본값은 128이다

- 3. 한 스위치 세그먼트당 지정 포트(designated port)를 하나씩 선택
-  지정 포트는 한 세그먼트당 하나씩 선택한다. 세그먼트란 스위치에 의해서 분리되지 않은 네트워크를 말한다.

- 4. 루트 포트도 지정 포트도 아닌 포트를 대체 포트(alternate port)라고 한다. 대체 포트는 항상 차단된다.


- 시스코의 스위치에서는 하나의 VLAN당 하나씩의 STP가 동작하며, 이를 PVST(per VLAN spanning tree) 또는 PVST+라고 한다.

- VLAN 1에 해당하는 STP 확인
- show spanning-tree vlan 1
- Root ID   Priority    32769                                       :   루트 스위치의 우선순위, 기본값 32768에 VLAN 번호가 더해진 값
            Address     000c.853b.3a33                              :   루트 스위치의 MAC 주소
            This bridge is the root                                 :   현재 스위치가 루트 스위치임을 표시
            Hello Time 2sec Max Age 20 sec Forward Delay 15 sec     :   루트 스위치에 설정된 각종 타이머 값

  Bridge ID Priority    32769 (priority 32768 sys-id-ext 1)         :   현재 스위치의 우선순위, 기본값 32768에 VLAN 번호가 더해진 값
            Address     000c.853b.3a33                              :   현재 스위치의 MAC 주소
            Hello Time 2sec Max Age 20 sec Forward Delay 15 sec     :   현재 스위치에 설정된 각종 타이머 값, 언젠가 현재 스위치가 루트 스위치의 역할을 할 때 사용된다.
            Aging Time 300

  Interface Role    Sts     Cost    Prio.Nbr    Type
  Fa0/23    Desg    FWD     19      128.23      P2p
  Fa0/24    Desg    FWD     19      128.24      P2p
- 인터페이스 번호
- 인터페이스의 STP 역할을 표시, 지정 포트 (Desg), 루트 포트 (root), 대체 포트 (Altn)
- 포트의 상태를 표시, 차단(BLK, blocking), 청쥐(LIS, listening), 학습(LRN, learning), 전송(FWD, forwarding), 비활성(Disabled)
- 각 포트의 경로값
- 포트의 우선순위와 포트 번호
- 포트의 종류, 현재의 포트가 포인트 투 포인트임을 나타낸다.

              (root)
- R1 <--> (DP)  SW1  (DP) <------->  (RP) SW2 (DP) <--> R2
               (DP)                       (DP)
                 ↑                         ↑
                 ↓                         ↓
               (RP)                 (Alternate port)
                            SW3

- SW1 브리지 우선순위 32768, MAC 주소 cc00.1e20.0000
- SW2 브리지 우선순위 32768, MAC 주소 cc01.1e20.0000
- SW3 브리지 우선순위 32768, MAC 주소 cc02.1e20.0000

- 논리적으로 루프가 사라진 네트워크
              (root)
- R1 <--> (DP)  SW1  (DP) <------->  (RP) SW2 (DP) <--> R2
               (DP)                       
                 ↑                         
                 ↓                         
               (RP)                 
                            SW3



- 스패닝 트리 포트 상태
- 차단 (Blocking)
- 데이터 프레임을 송수신하지 않는다. 그러나 BPDU는 수신한다.
- 포트가 활성화되면 역할에 따라 청취 또는 차단 상태가 된다. 즉, 활성화된 포트의 역할이 루트 포트 또는 지정 포트이면 바로 청취 상태가 된다.
- 대체 포트이면 바로 차단 상태가 된다. 대체 포트에서 루트 포트나 지정 포트로 변경되면 20초 후에 청쉬 상태로 변경된다. 이 타이머를 MAX Age라고 한다.
- 포트의 역할이 지정 포트라면 청취 상태에서 BPDU를 전송하기 시작한다. 청취 상태에서 기본적으로 15초가 경과되면 학습 상태로 변경된다. 이 시간을 전송 지연(forward delay) 타이머라고 한다.
- 학습 상태에서는 MAC 주소 테이블을 채우기 시작한다. 학습 상태에서 기본적으로 15초가 경과되면 전송 상태로 변경된다. 이 떄에도 전송 지연 타이머를 사용
- 전송 상태에서는 데이터 프레임을 정상적으로 송수신한다. 안정된 네트워크라면 스위치 간 연결하는 각 포트의 상태는 전송 or 차단 상태 중 하나에 머물러 있다.
- 다운 상태에 있는 포트는 모두 STP 비활성 상태(disable state)라고 한다.
- 비활성 상태에서는 이용자 트래픽과 BPDU 모두를 송수신하지 않는다
- 스위치 전원을 키면 하드웨어의 구성 및 동작을 확인하는 POST(power on self test)라는 과정을 거친다. 그런 다음 포트의 역할이 지정 or 루트 포트로 결정되면 해당 포트는 청쉬 상태 및 학습 상태를 거쳐 30초 후에 전송 상태로 변경된다.
- 기본적으로 포트는 활성화되면 청취 상태부터 시작하기 때문이다.


- 네트워크 장애 시 STP의 동작
- 스위치 네트워크 구조가 변경되면 STP 포트의 역할이 변경되고 STP 포트의 상태도 변경된다.


- 간접 연결된 링크 다운 시의 동작 
              (root)
- R1 <--> (DP)  SW1  (DP->Disabled) <XXXXXXXX>  (RP->Disabled) SW2 (DP) <--> R2
               (DP)                                         (DP -> RP)
                 ↑                                              ↑
                 ↓                                              ↓
               (RP)                                     (Alternate port -> DP)
                                                            (BLK -> FWD)
                                        SW3
- SW3이 SW2에게서 수신하는 BPDU에 포함된 루트 브리지 ID가 SW1에서 값이 더 높은 SW2의 것으로 변경된다.
- 이와 같이 루트 브리지 ID가 후순위로 변경된 것을 후순위 BPDU라고 한다.
- 후순위 BPDU를 수신하여 SW2와 루트 스위치 간의 링크에 장애가 발생했다는 것을 알게된 SW3은 F1/12 포트의 역할을 DP로 변경한다.
- 상태는 전송 상태로 바로 변경되지 않는다. 20초인 맥스 에이지 타이머가 만료될 떄까지 기다린다.
- 이후 청쉬 상태에서 15초, 학습 상태에서 15초를 더 기다린 다음, 장애 발생 50초 후에야 전송 상태로 변경하고 데이터 프레임을 송수신한다.
- 간접 링크가 다운되었을 때에는 50초가 지나야 전송 상태로 변경되고 이 기간 동안 SW2에 접속된 장비들은 외부와의 통신이 두절된다.
- STP의 단점이다.

- 직접 연결된 링크 다운 시의 동작 
              (root)
- R1 <--> (DP)  SW1  (DP->Disabled) <-------->  (RP->Disabled) SW2 (DP) <--> R2
          (DP->Disabled)                                       (DP)
                 ↑                                              ↑
                 x
                 x
                 x                                           
                 ↓                                              ↓
          (RP->Disabled)                               (Alternate port -> RP)
                                                            (BLK -> FWD)
                                        SW3
- SW3은 맥스 에이지 타이머 20초를 동작시키지 않고 바로 청쉬 상태로 들어간다.
- 따라서 청취 상태, 학습 상태 거쳐 30초만에 F1/12 포트가 전송 상태로 변경된다.


- 포트 패스트
- 기본적으로 스위치는 종단 장비가 접속되어 있어도 스패닝 트리 프로토콜에 의해 청취, 학습 및 전송 상태 단계를 거친다.
- 포트 패스트는 포트가 활성화되면 바로 전송 상태가 되게 하는 것을 말한다.
- PC, 서버 등과 같이 종단장치와 연결된 포트에 많이 설정한다.
- 포트 패스트가 설정된 포트라도 BPDU를 수신하면 그에 따른 적절한 STP 동작을 취한다.

- debug spanning-tree events
- STP 디버깅

- interface f1/1
- spanning-tree portfast
- 포트패스트 활성화


- 루트 스위치 조정
- VLAN당 서로 다른 스위치를 루트 스위치로 동작시켜 부하분산를 유도하는 것이 좋다

- 먼저 각, 스위치 간을 연결하는 포트를 트렁크로 설정한다
- switchport trunk encapsulation dot1q
- switchport mode trunk

- VTP 설정
- vtp domain VTP_01

- VLAN 만들기
- vlan 10
- name 1st_VLAN
- vlan 20
- name 2st_VLAN

- 루트 스위치 설정
- spanning-tree vlan 10 root primary
- spanning-tree vlan 10 root secondary

- 직접 브리지 우선 순위 조정
- spanning-tree vlan 20 priority 0
- spanning-tree vlan 20 priority 4096
- STP 브리지 우선순위 조정 시 이더스위치 모듈에서는 0~65535 사이의 아무 값이나 사용할 수 있다. 그러나 카탈리스트 스위치는 4096의 배수값을 사용해야 한다.

- show spanning-tree vlan 10 
- 루트 스위치 확인

