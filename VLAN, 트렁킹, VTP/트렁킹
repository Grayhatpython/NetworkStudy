- 트렁킹
- 트렁크 또는 트렁크 포트란 복수 개의 VLAN에 소속된 포트를 말한다.
- 트렁크가 사용하는 프로토콜을 트렁킹 프로토콜이라고 한다.

- 트렁크 포트와 액세스 포트
- PC1 ← → (VLAN 10)    (트렁크 포트)    (VLAN 10) ← → PC3
                     SW1   ← →   SW2 
                          F1/10
  PC2 ← → (VLAN 20)     (VLAN 10)     (VLAN 20) ← → PC4
                        (VLAN 20) 

- 위의 예시처럼 스위치 간을 연결하는 F1/10 포트는 VLAN 10과 VLAN 20에 소속된 프레임을 모두 전송해야 한다.
- 따라서 F1/10 포트는 VLAN 10과 VLAN 20 모두에 소속 시켜야한다.
- 이처럼 복수 개의 VLAN에 소속된 포트를 트렁크 포트라고 한다.
- 두 스위치에서 사용하는 VLAN 번호가 동일하다면 스위치 간을 연결하는 포트를 액세스 포트로 설정할 수 있다.


- 트렁킹 프토로콜
- 트렁크 포트로 프레임을 전송할 때에는 VLAN 번호를 알려주어야한다!

- PC1 ← → (VLAN 10)    (트렁크 포트)    (VLAN 10) ← → PC3
                     SW1   ← →   SW2 
                          F1/10
                        (VLAN 10)    
                        (VLAN 20) 

- PC1이 브로드캐스트 프레임을 전송하는 경우
- 브로드캐스트 프레임은 동일한 VLAN에 소속된 모든 포트로 전송해야 하므로 SW1은 이 프레임을 트렁크 포트인 F1/10 포트를 통하여 SW2로 전송한다.
- 일반 이더넷 프레임에는 VLAN 번호를 표시하는 필드가 없다. 따라서 일반 이더넷 프레임을 사용한다면 SW2는 F1/10을 통하여 SW1에서 수신한 브로드캐스트 프레임을 어느 VLAN으로 플러딩해야 하는지 알 수 없다
- 따라서, SW1은 브로드캐스트 프레임을 전송할 떄 VLAN 번호를 표시해야 하며, 이떄 사용하는 프로토콜이 트렁킹 프로토콜이다.

- 트렁킹 프로토콜 동작 방식
- 1. 액세스 포트를 통하여 프레임을 수신하면 스위치는 해당 프레임이 소속되 VLAN 번호를 알 수 있다.
- 2. SW1이 트렁크 포트를 통하여 해당 프레임을 전송하면서 VLAN 번호를 표시합니다. 트렁크 포트를 통하여 프레임을 수신한 SW2는 VLAN 표시를 확인하고, 이 프레임이 소속된 VLAN 번호를 알게된다.
- 3. SW2는 프레임의 VLAN 정보를 제거하고 VLAN 10에 소속된 모든 포트로 프레임을 전송한다. 이처럼, 액세스 포트에 접속된 장비들은 VLAN의 존재를 인식하지 못한다.
-   VLAN 표시 방법은 트렁킹 프로토콜에 따라 다르다. 트렁킹 프로토콜은 트렁킹 인캡슐레이션이라고도 한다. 시스코이더넷 스위치에서 사용되는 트렁킹 인캡슐레이션은 ISL와 802.1Q다.


- 802.1Q 트렁킹
- IEEE 802.1Q에서 정의된 표준 트렁킹 프로토콜이다
- 이 방식은 이더넷 프레임의 출발지 주소 다음에 4바이트 길이의 802.1Q 태크를 추가하여 VLAN 번호화 기타 정보를 표시한다.

- 802.1Q 프레임 포맷
- 목적지 주소 | 출발지 주소 | 802.1Q 태그 | 타입/길이 | 데이터 | FCS
                               ↑
    이더타입(16bits) | 우선순위(3bits) | CFI(1bits) | VLAN 번호(12bits)

- 이더타입 
- 현재의 프레임이 802.1Q 프레임이라는 것을 표시. 항상 값이 0x8100이다

- 우선순위 
- 프레임의 우선순위를 표시한다
- 802.1P 우선순위 필드 또는 , CoS(Class of Service) 필드라고도 한다.
- 0에서 7 사이의 값을 가지며, 값이 클수록 우선순위가 높다.
- 음성이나 동영상 데이터를 전송할 때 이 값을 높게 지정하여 우선순위를 높이고, 스위치에서 다른 프레임보다 빨리 전송되게 할 수 있다.

- VLAN 번호
- 프레임의 VLAN 번호를 표시한다.
- 12비트이므로, 4096개의 VLAN이 지원된다.

- switchport trunk encapsulation dot1q
- 트렁킹 인캡슐레이션 802.1Q 지정
- 트렁킹 프로토콜을 지정한다고 해서 해당 포트가 트렁크로 동작하는 것은 아니고 해당 포트가 트렁크로 동작할 떄 802.1Q 방식을 사용한다는 것이다.


- 네이티브 VLAN
- 802.1Q에서는 네이티느 VLAN을 지원한다.
- 네이티브 VLAN이란 트렁크 포트로 전송 시 VLAN을 표시를 하지 않는 VLAN을 말한다.


- ISL ( Inter-Switch Link )
- 시스코에서 개발한 트렁킹 프로토콜이다
- 802.1Q와 달리 확장 VLAN을 지원하지 못하여 시스코 스위치에서도 점차 802.1Q로 대체되고 있는 추세다.
- 이더넷 프레임을 변경하지 않고, 프레임 앞에 26바이트의 ISL 헤더를 추가한다. 그리고 이더넷 FCS 다음에 별도로 4바이트 길이의 ISL FCS를 추가한다. FCS는 수신한 프레임의 에러 발생 여부를 확인하는데 사용

- ISL 프레임 포맷 
- ISL 헤더 (26bytes) | 이더넷 헤더 (14bytes) | 데이터 (46-1500bytes) | 이더넷 FCS (4bytes) | ISL FCS (4bytes)

- ISL 헤더 주요 필드
- DA 
- 프레임이 ISL 프레임이라는 것을 나타낸다.

- User
- 이더넷 프레임의 우선순위를 표시한다.

- VLAN 번호
- 15비트가 할당되어 있으나 실제로는 10비트만 사용되며, 1024개의 VLAN만 지원한다.

- BPDU
- BDPU, VTP or CDP 프레임을 전송할 떄 이 필드를 1로 표시한다.
- BPDU 비트가 1로 설정된 프레임을 수신하면, 스위치는 이 프레임의 최종 목적지가 자신임을 알고, 그 내용을 해독하고, 적절한 동작을 취한다.

- switchport trunk encapsulation isl
- 트렁킹 인캡슐레이션 ISL로 지정


- 스위치 포트의 DTP 모드
- DTP ( Dynamic Trunking Protocol )란 시스코 스위치에서 상대 스위치와 트렁크 관련 사항을 협상할 때 사용되는 프로토콜이다.
- DTP는 트렁크 포트 전환여부와 트렁크 포트로 동작 시 사용할 프로토콜을 협상한다.

- DTP 모드 
- 액세스 ( 정적 포트 )
- 항상 액세스 포트로 동작
- switchport mode access

- 트렁크 ( 정적 포트 )
- 항상 트렁크 포트로 동작
- 상대 포트를 트렁크 포트로 동작 시키기 위한 DTP 패킷을 전송한다.
- switchport trunk encapsulation dot1q
- switchport mode trunk

- 다이나믹 디자이어러블 ( 동적 포트 )
- 상대가 액세스 포트인 경우에만 액세스 포트로 동작, 나머지 경우는 트렁크 포트로 동작
- switchport mode dynamic desirable

- 다이나믹 오토 ( 동적 포트 )
- 상대가 액세스나 다이나믹 오토인 경우 액세스 포트로 동작, 나머지 경우는 트렁크 포트로 동작
- switchport mode dynamic auto


- PC1 ← → (VLAN 10)    (트렁크 포트)    (VLAN 10) ← → PC3
                     SW1   ← →   SW2 
                          F1/10
  PC2 ← → (VLAN 20)     (VLAN 10)     (VLAN 20) ← → PC4
                        (VLAN 20) 

- interface f1/10
- 트렁크로 동작시킬 인터페이스
- switchport trunk encapsulation dot1q
- 트렁킹 프로토콜 지정
- switchport mode trunk
- 해당 포트를 트렁크로 동작
- switchport trunk native vlan 999
- 트렁킹 프로토콜을 802.1Q로 사용할 경우 네이티브 VLAN을 지정할 수 있다. 지정하지 않으면 네이티브 VLAN값이 1이 된다. 포트 양측에 설정된 네이티브 VLAN값이 다르면 에러 메세지가 표시된다.


- show interface trunk
- 트렁크 동작 상황 확인
- Port | Mode | Encapsulation | Status | Native vlan
- 트렁크로 동작하는 포트 표시
- 트렁크 설정 방식을 표시
- 사용 중인 트렁킹 프로토콜 표시
- 현재 트렁크로 동작 중임을 표시
- 네이티브 vlan 번호 표시


- show interface status
- 트렁크로 동작 중인 포트를 확인 