- VLAN ( Virtual LAN , 가상 랜)
- 논리적으로 분할된 스위치를 말한다.

- VLAN을 사용하는 이유
- 스위치에 접속된 장비들의 성능 향상 및 보안성 증대
- VLAN이 없는 경우 스위치에 접속된 장비가 많으면 수많은 브로드캐스트 프레임을 수신하고 이를 확인하기 위하여 CPU를 낭비하게 된다.
- 스위치에 VLAN을 설정하면 트랜스패런트 브리징 프로토콜에서 브로드캐스트는 동일한 VLAN에 소속된 포트로만 플러딩된다.
- 즉, 하나의 VLAN에서 발생한 브로드캐스트 프레임이 다른 VLAN에 소속된 포트로 전송되는 것을 차단한다.
- VLNA을 사용하면 브로드캐스트 프레임이 전송되는 범위 즉, 브로드캐스트 도메인의 크기가 줄어들어 각 장비들이 불필요한 프레임을 처리해야 하는 일도 감소한다.
- 서로 다른 VLAN에 소속된 장비들 간의 통신을 위해서는 라우터나 L3 스위치와 같은 네트워크 계층의 장비가 필요하다.

-                    SW1   
      ↑               ↑                ↑  
F0/0 (VLAN10)    F0/0 (VLAN10)    F0/0(VLAN20)    
  1.1.10.1         1.1.10.2         1.1.20.3
     R1               R2               R3


- VLAN 번호
- VLAN은 번호(ID)로 구분한다.
- 사용 가능한 VLAN 번호는 1~4094 사이다
- 1~1005 사이인것을 일반 VLAN이라고 하고, 1002~1005는 토큰링과 FDDI라는 프로토콜으로 사용된다.
- 요즘은 토큰링과 FDDI 프로토콜을 사용하지 않으므로 이 번호 역시 실제로는 사용되지 않는다.
- 이더넷에서 사용할 수 있는 일반 VLAN 번호는 1~1001까지다.
- 1006~4094인 것을 확정 VLAN 이라고 한다.
- 기본적으로 스위치의 모든 포트는 VLAN 1에 소속되어 있다.

- show vlan brief
- 현재 설정된 VLAN 정보 확인

- VLAN 설정
- vlan [number]
- name [vlan name]
- exit
- 이름을 별도로 지정하지 않으면 자동으로 VLAN0010과 같이 VLAN이라는 단어와 4자리의 VLAN번호가 합져진 이름이 지정된다.
- vlan 명령어를 사용하여 다음 VLAN을 만들려면 exit 명령어를 사용하여 VLAN 설정 모드에서 빠져나와야 해당 VLAN이 만들어진다.

- VLAN 할당
- interface range f1/1 - 2, interface range f0/5 - 6, f0/9
- 포트 설정

- switchport mode access
- 포트의 모드를 액세스 포트로 지정. 액세스 포트는 하나의 VLAN에만 소속되는 포트다.
- 이렇게 지정하지 않으면 DTP라는 프로토콜이 동작하여 인접한 장비와의 협상 과정을 거쳐 포트의 모드가 결정된다.
- 모드를 명시적으로 지정한 스위치 포트를 정적(static) DTP 포트라고 하고, 협상된 포트를 동적(dynamic) DTP 포트라고 한다.
- 동적 DTP 포트를 사용하면 보안상 취약하다.
- 많은 스위치 설정 명령어들이 정적 DTP 포트에서 동작하므로 가능한 포트의 모드를 지정하는 것이 좋다

- switchport access vlan 10
- 해당 포트에 VLAN 번호를 지정 

- 이렇게 지정하면 동일 VLAN에 소속된 장치간의 통신만 가능하다.


-                    R4
              F0/0.10   F0/0.20
           1.1.10.254   1.1.20.254
                      ↑
                      ↓
                 F1/4 (Trunk)
                      SW1   
  F1/1 (VLAN10)   F1/2 (VLAN10)     F1/3 (VLAN10)                
      ↑                ↑                 ↑ 
      ↓                ↓                 ↓ 
    F0/0              F0/0              F0/0    
  1.1.10.1          1.1.10.2           1.1.20.3
 1.1.10.254 (GW)  1.1.10.254 (GW)   1.1.20.254 (GW)
     PC1              PC2               PC3


- 서로 다른 VLAN간의 라우팅
- VLAN 간의 라우팅을 위하여 흔히 사용하는 방법은 위의 예시와 같이 라우터를 이용하는 것이다
- R4을 SW1에 접속시키고, R4의 인터페이스를 논리적으로 분할아여 각각 VLAN 10과 VLAN 20DP 할당한다.
- 이처럼 하나의 물리적 인터페이스를 여러 개의 VLAN에 소속시키는 것을 트렁킹이라고 하며, 해당 포트를 트렁크라고도 한다.
- 논리적으로 분할된 각 인터페이스를 서브인터페이스(sub-interface)라고 한다.
- R4의 연결되는 SW1의 F1/4 포트도 트렁크로 설장한다.
- VLAN 10에 소속된 PC1,PC2에서 게이트웨이를 지정할 때 R4의 VLAN 10에 할당된 서브인터페이스를 설정한 IP 주소를 사용한다.
- VLAN 20에 소속된 PC3,에서 게이트웨이를 지정할 떄 R4의 VLAN 20에 할당된 서브인터페이스에 설정한 IP 주소를 사용한다.

- 서브인터페이스 만들기 ( R4 )
- interface f0/0
- no shutdown
- 주 인터페이스 활성화

- interface f0/0.10
- 서브인터페이스를 만든다. 
- 주 인터페이스 번호 다음에 점을 찍고, 적당한 서브인터페이스 번호를 지정
- 0~42억 사이의 어느 번호를 사용해도 상관없으나, VLAN 번호, 서브넷 번호 및 서브인터페이스 번호를 동일한 것으로 지정하면 관리 및 장애 처리가 편하다

- encapsulation dot1q 10
- VLAN 번호를 지정 

- ip address 1.1.10.254 255.255.255.0
- VLAN 10에 소속된 호스트들이 게이트웨이 주소로 사용할 ip 주소를 지정

- interface f0/0.20
- encapsulation dot1q 20
- ip address 1.1.20.254 255.255.255.0


- 트렁크 설정하기 ( SW1 )
- interface f1/4
- R4와 연결되는 인터페이스 설정 모드

- switchport trunk encapsulation dot1q
- 트렁킹 방식을 지정

- switchport mode trunk
- 트렁크 포트로 지정


- 게이트웨이 주소 지정
- R1 : ip route 0.0.0.0 0.0.0.0 1.1.10.254
- R2 : ip route 0.0.0.0 0.0.0.0 1.1.10.254
- R3 : ip route 0.0.0.0 0.0.0.0 1.1.20.254

- PC에서 게이트웨이라고 부르는 것을 라우터에서는 디폴트 루트라고 하며, 의미는 유사하다
- 상세한 경로를 모르면 모두 이쪽으로 전송하라라는 의미다.


- 핑을 VLAN 간의 라우팅 동작 방식 확인
- ping 1.1.20.3

- 1. R1에서 다른 VLAN에 소속된 장비로 통신을 시작하면 ARP를 해야 한다. 이떄 목적지 IP주소와 R1의 주소가 서브넷이 다르므로 R1은 게이트웨이 1.1.10.254의 MAC 주소를 찾는 ARP 요청 패킷을 전송한다.
- 2. 스위치는 목적지가 브로드캐스트 프레임을 수신하면 수신 포트를 제외하고 동일 VLAN에 소속된 모든 포트로 플러딩한다. 트렁크 포트는 모든 VLAN에 소속된 것이므로 R4에게도 ARP 프레임이 전송된다.
- 3. R4가 자신의 MAC 주소를 찾는 ARP에 대해서 응답한다.
- 4. R1은 R4가 응답한 ARP 응답 패킷을 수신하고, R4의 MAC 주소를 알게 된다.
- 5. R1은 목적지 IP 주소가 R3의 주소인 1.1.20.3으로 설정되고, 목적지 MAC 주소는 게이트웨이인 R4의 것으로 설정된 핑 요청 패킷을 R4에게 전송한다.
- 6. R4은 목적지 MAC 주소가 자신의 것인 프레임을 수신한 다음, L2 헤더를 제거합니다. 이처럼 라우터는 프레임을 수신하면 L2 헤더를 제거하고 새로운 것으로 대체한다. L2 헤더를 제거하고 L3 헤더를 확인한 R4는 목적지 IP 주소가 VLAN 20에 소속된 
-  1.1.20.3 이라는 것을 알게 된다
- 7. R4는 목적지 IP 주소가 1.1.20.3인 장비의 MAC 주소를 알아내기 위하여 VLAN 20으로 ARP 패킷을 전송한다. 이떄 출발지 MAC 주소는 R1이 아닌 R4의 것으로 대체한다.
- 8. VLAN 20에 소속되 F/13 포트를 통해 R3이 자신을 찾는 ARP 요청 패킷을 수신한다.
- 9. R3이 ARP 응답 패킷으로 자신의 MAC 주소를 게이트웨이인 R4에게 알려준다
- 10. R3의 ARP 응답을 R4가 수신하여 IP 주소 1.1.20.3의 MAC 주소를 알게된다.
- 11. R4는 출발지 MAC 주소가 R4의 MAC 주소, 출발지 IP 주소는 R1의 주소인 1.1.10.1로 설정되고, 목적지 MAC 주소가 R3의 MAC주소, 목적지 IP 주소는 R3의 주소인 1.1.20.3으로 설정된 핑 요청 패킷을 R3에게 전송한다.
- 12. R3이 R4를 거쳐서 R1이 전송한 핑 요청 패킷을 수신한다.
- 13. 이후 R3은 출발지 MAC 주소 및 출발지 IP 주소가 자신의 것으로 설정되고, 목적지 MAC 주소가 R4의 MAC 주소, 목적지 IP 주소는 R1의 주소인 1.1.10.1으로 설정된 핑 응답 패킷을 게이트웨이인 R4에게 전송한다.
- 14. 게이트웨이인 R4는 출발지 MAC 주소를 자신의 것으로 대체하고, 목적지 MAC 주소는 R1의 것으로 대체된 프레임을 R1에게 전송하면 R1과 R3 간의 통신이 이루어진다. 
- L3 장비를 통과할 때마다 L2 주소들은 변경되지만 L3 주소인 IP 주소는 변경되지 않는다!


- VLAN 내부의 통신 방식
- 1. R1에서 1.1.10.2로 통신을 시작하면 ARP가 시작되고, 목적지 IP 주소와 R1의 주소가 서브넷이 동일하므로 직접 목적지 IP 주소인 1.1.10.2의 MAC 주소를 찾는 ARP 요청 패킷을 전송한다.
- 2. 스위치는 목적지가 브로드캐스트인 프레임은 수신 포트를 제외하고 동인 VLAN에 소속된 모든 포트롤 플러딩하므로, F1/2 포트로 ARP 요청 패킷이 전송된다.
- 3. R2는 자신의 MAC 주소를 찾는 ARP에 대해서 응답한다.
- 4. R1은 R2가 전송한 ARP 응답 패킷을 수신하고, 상대의 MAC 주소를 알게 된다
- 5. R1은 목적지 IP 주소와 MAC 주소가 R2의 것으로 설정된 핑 요청 패킷을 스위치로 전송한다.
- 6. R2는 핑 요청 패킷을 수신한다. 
- 동일한 VLAN에 소속된 장비들 간의 통신에는 라우터를 거치지 않고 두 장비 간의 직접 통신이 이루어진다!