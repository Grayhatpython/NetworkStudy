- ARP ( Address Resolution Protocol )
- 이더넷 프레임을 만들기 위해서는 출발지 MAC 주소와 목적지 MAC 주소가 필요하다.
- 그런데, 처음 통신을 시작할 떄는 상대방의 MAC 주소 즉, 목적지 AMC 주소를 모른다.
- 그래서 이더넷에서 상대방의 MAC 주소를 알아내기 위하여 사용하는 프로토콜이 ARP다

- ARP 동작 방식
- R1 ( F0/0 ) <------------------> ( F1/1 )   SW1    ( F1/2 ) <------------------> ( F0/0 ) R2
                                            ( F1/3 )  
                                               ↑
                                            ( F0/0 )        
                                               R3
- R1: 1.1.1.1 , 0000.0000.0001
- R2: 1.1.1.2 , 0000.0000.0002
- R3: 1.1.1.3 , 0000.0000.0003

- R1에서 R2로 핑을 하는 경우

- 1.상대방의 MAC 주소가 필요한 경우
- 목적지 MAC 주소 | 출발지 MAC 주소 | 출발지 IP 주소 | 목적지 IP 주소 | 데이터
        ?         0000.0000.0001      1.1.1.1        1.1.1.2     1010...

- R1이 핑 요청 패킷을 R2로 보내려면 IP 패킷을 이더넷 프레임에 실어서 전송해야 한다.
- 이를 위해서 출발지 및 목적지 IP 주소와 MAC 주소를 알아햐 한다.
- 출발지 MAC 주소와 IP 주소는 R1 자신의 것이므로 알 수 있고, 목직저 IP는 PING 1.1.1.2와 같이 핑의 목적짖 주소를 명시하므로 알 수 있다.
- 그러나 IP 주소가 1.1.1.2인 장비의 MAC 주소를 모른다. 
- 이처럼 목적지 이더넷 장비의 MAC 주소를 알아낼 때 사용하는 프로토콜이 ARP이다.


- 2.ARP 요청 프레임 전송
- 목적지 MAC 주소 | 출발지 MAC 주소 | 출발지 IP 주소 | 목적지 IP 주소 | 데이터
  FFFF.FFFF.FFFF  0000.0000.0001    1.1.1.1        1.1.1.2       ARP 요청

- 이를 위하여 R1은 목적지 MAC 주소를 브로드캐스트 주소로 설정한 ARP 요청 프레임을 전송한다.
- ARP 요청 내용은 'IP 주소가 1.1.1.2인 장비의 MAC 주소가 무엇인가?' 라는 내용이 들어간다.
- 스위치는 목적지 MAC 주소가 브로드캐스트로 설정된 프레임을 수신하면 수신 포트를 제외한 모든 포트로 전송한다.
- 결과적으로 R2, R3가 ARP 요청 패킷을 수신한다.


- 3.ARP 응답 패킷
- 목적지 MAC 주소 | 출발지 MAC 주소 | 출발지 IP 주소 | 목적지 IP 주소 | 데이터
  0000.0000.0001  0000.0000.0002    1.1.1.2        1.1.1.1       ARP 응답

- IP 주소 1.1.1.2가 자신의 것임을 알고 있는 R2는 'IP 주소가 1.1.1.2인 장비의 MAC 주소는 0000.0000.0002이다' 라는 내용의 ARP 응답 패킷을 전송한다.
- R3는 자신과 무관하므로 응답하지 않는다.


- 4.ARP 테이블 저장
- 이제 R1은 완전한 이더넷 프레임을 만들 수 있다.


- 5.핑 요청 패킷 패킷
- 목적지 MAC 주소 | 출발지 MAC 주소 | 출발지 IP 주소 | 목적지 IP 주소 | 데이터
  0000.0000.0002  0000.0000.0001     1.1.1.1        1.1.1.2       1010...

- 따라서 핑 요청 패킷을 만들어 R2에게 전송한다.


- 6.핑 요청 패킷 수신
- 목적지 MAC 주소 | 출발지 MAC 주소 | 출발지 IP 주소 | 목적지 IP 주소 | 데이터
  0000.0000.0001  0000.0000.0002     1.1.1.2        1.1.1.1       1010...

- 이를 수신한 R2는 R1에게 핑 응답 패킷을 전송한다.



- debug arp
- ARP 디버깅 명렁어
- arp 디버깅 시 모르는 상대의 MAC 주소를 0000.0000.0000으로 표시하지만, 외부의 이더넷 헤더에는 FFFF.FFFF.FFFF.로 설정된다.
- 이더넷에서 처음 핑을 하면 한 두 개의 패킷이 빠지는데, 그 이유는 ARP가 성공하기 전에는 핑 패킷을 전송할 수 없어 타임아웃되기 때문이다.

- show arp
- ARP 테이블 확인


- ARP 대상 결정 방법
- ARP 요청 시 항상 목적지 IP 주소의 MAC 주소를 요청하는 것은 아니다.
- 특정 장비가 ARP 요청 패킷을 전송할 떄에는 다음과 같은 규칙을 적용한다.
- 1. 목적지 IP 주소가 자신과 동일한 서브넷 소속이면 해당 목적지 IP 주소를 가진 장비에게 직접 MAC 주소를 요청한다.
- 2. 목적지 IP 주소가 자신과 다른 서브넷 소속이면 게이트웨이에게 게이트웨이의 MAC 주소를 요청한다.
- 2-1. 이후 목적지 IP 주소가 다른 서브넷 소속인 패킷들을 게이트웨이로 전송하고, 게이트웨이 라우터는 라우팅 테이블을 참조하여 해당 패킷들을 목적지 방향으로 라우팅시킨다.

- 게이트웨이 주소를 엉뚱한 것으로 지정하면 어떻게 될까..?
- 인터넷이 될 수도 있고 안될수도 있다.
- 라우터의 프록시 ARP라는 기능 떄문이다
- 프록시 ARP란 자신의 IP주소가 아니더라도 라우팅 가능한 IP 주소에 대한 ARP 요청을 받으면 라우터가 자신의 MAC 주소를 알려주는 것을 말한다.
- 인터넷과 연결된 대부분의 라우터는 '모든 패킷을 인터넷으로 전송하라' 라는 의미의 디폴르 루프라는 것이 설정되어 있다.
- ARP 요청을 받으면 라우터는 자신의 MAC 주소를 알려준다.
- 그러면 PC는 실제 데이터의 목적지가 다른 서브넷인 IP 패킷을 라우터로 전송하고, 라우터는 이를 인터넷 방향으로 라우팅시켜 통신이 된다.
- no ip proxy-arp라는 명령어를 이용하여 프록시 arp를 사용하지 않게 하면 엉뚱한 게이트웨이 주소를 사용할 수 없게 된다.


- 트랜스패런트 브리징
- 이더넷 스위치는 MAC 주소 테이블을 참조하여 이더넷 프레임을 목적지 방향으로 전송한다.
- MAC 주소 테이블을 만들고, 유지하며, MAC 주소 테이블을 참조하여 프레임을 전송하는 것
- 트랜스패런트는 보통 사용자가 의식하지 못하게 자동으로 동작한다 라는 의미로 사용된다.

- 트랜스패런트 브리징 절차 ( 위의 네트워크 환경을 기준으로 설명함 )

- 1.초기의 MAC 주소 테이블은 비어 있음
 MAC 주소 | 포트 번호
  

- 2.러닝과 플러딩
    MAC 주소     | 포트 번호
0000.0000.0001      F1/1

- 목적지 MAC 주소 | 출발지 MAC 주소 | 출발지 IP 주소 | 목적지 IP 주소 | 데이터
  FFFF.FFFF.FFFF  0000.0000.0001    1.1.1.1        1.1.1.2       ARP 요청

- R1이 ARP 요청 프레임을 전송하면 스위치가 해당 인터페이스를 통하여 이를 수신한 다음 해당 이더넷 프레임의 출발지 MAC 주소를 읽는다.
- MAC 주소 테이블에 해당 출발지 MAC 주소가 없으면 출발지 MAC 주소와 수신 포트번호를 기록한다. 이것을 러닝(학습) 과정이라고 한다.
- R1이 출발지 MAC 주소가 0000.0000.0001인 프레임을 전송하고, SW1은 F1/1 포트를 통하여 이를 수신한다.
- SW1은 프레임의 출발지 MAC 주소를 확인하여 수신 포트번호와 함께 이를 MAC 주소 테이블에 기록한다.
- 목적지 MAC 주소가 브로드캐스트 주소이거나, MAC 주소 테이블에 없는 유니캐스트 또는 멀티캐스트 주소이면 수신 포트를 제외하고 동일한 VLAN에 속하는 모든 포트로 다 전송한다. 이 과정을 플러딩이라고 한다.


- 3.포워딩
    MAC 주소     | 포트 번호
0000.0000.0001      F1/1
0000.0000.0002      F1/2

- 목적지 MAC 주소 | 출발지 MAC 주소 | 출발지 IP 주소 | 목적지 IP 주소 | 데이터
  0000.0000.0001  0000.0000.0002    1.1.1.2        1.1.1.1       ARP 응답

- R1이 전송한 ARP 요청 프레임의 목적지 주소가 FFFF.FFFF.FFFF인 브로드캐스트로 되어 있으므로 SW1은 이 프레임을 수신한 F1/1 포트를 제외한 나머지 포트 F1/2, F1/3으로 플러딩시킨다.
- 목적지 주소가 MAC 주소 테이블에 존재 시, 해당 목적지 MAC 주소를 가진 유니캐스트 프레임을 수신하면 목적지 포트로 프레임을 전송한다. 이 과정을 포워딩이라고 한다.
- SW1은 R2가 전송한 ARP 응답 프레임의 수신 포트 F1/2와 출발지 MAC 주소 0000.0000.0002를 MAC 주소 테이블에 기록한다. 즉, R2의 MAC 주소를 러닝한다
- 이후, 목적지 MAC 주소가 0000.0000.0001인 것을 확인하고 MAC 주소 테이블을 참조한다.
- MAC 주소 테이블에 목적지가 0000.0000.0001인 프레임은 F1/1 포트로 전송하라고 되어 있으므로 이를 F/1/로 전송한다. 즉, 수신한 이더넷 프레임을 F1/1 포트로 포워딩한다.
- MAC 주소 테이블에 해당 주소가 있으면 에이징 타이머를 초기화 한다


- 4.에이징
- 스위치가 MAC 주소를 MAC 주소 테이블에 기록할 때 항상 타이머를 동작시킨다.
- 기본적으로 5분 동안 해당 MAC 주소가 출발지 주소로 설정된 프레임을 수신하지 못하면 스위치는 해당 MAC 주소를 MAC 주소 테이블에서 제거한다.
- 이렇게 타이머를 설정 후, 동일 출발지 MAC 주소를 가진 프레임을 수신할 때마다 타이머를 초기화하고, 정해진 시간 동안 해당 프레임의 활동이 없으면 MAC 주소 테이블에서 제거하는 과정을 에이징이라고 한다.


- 5.필터링
- MAC 주소 테이블상에 출발지/목적지 MAC 주소가 동일한 포트에 소속되어 있으면 해당 프레임을 차단한다. 이 과정을 필터링이라고 한다.


- show mac-address-table
- MAC 주소 테이블 확인 
- 목적지 MAC 주소, MAC 주소의 형태, 해당 MAC 주소가 소속된 VLAN 번호, 해당 MAC으로 가기 위한 포트 등이 기록되어 있다.

- show mac-address-table count
- MAC 주소 테이블 최대 용량
- MAC 주소 테이블에 저장된 MAC 주소는 많지 않다
- MAC 주소는 라우터나 L3 스위치 등 네트워크 계층 장비를 통과할 때마다 해당 장비의 MAC 주소로 변경되기 떄문이다.
- MAC 주소 테이블이 차면 더 이상 기록되지 않고 이후 수신된 새로운 목적지 MAC 주소를 가진 프레임들은 모두 플러딩된다.
- 이처럼 MAC 주소 테이블을 채우는 공격을 MAC 플러딩 공격이라고 한다.
- 이를 방어하는 방법 중의 하나는 라우터, 서버 등 중요한 장비들의 MAC주소가 플러딩 되지 않도록 정적으로 MAC 주소 테이블을 만드는 것이다.

- mac-address-table static [0000.0000.0001] interface [F1/1] vlan [1]
- 목적지 MAC 주소, 목적지 MAC 주소와 연결되는 인터페이스 이름, 목적지 MAC 주소가 소속된 VLAN 번호